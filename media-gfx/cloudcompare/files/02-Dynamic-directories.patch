From: Romain Janvier <romain.janvier@hotmail.fr>
Date: Mon, 14 Jan 2013 21:15:12 +0100
Subject: Dynamic directies

---
 qCC/CMakeLists.txt  |   11 +-
 qCC/ccGLWindow.cpp  |    6 +-
 qCC/config.h.in     |    1 +
 3 files changed, 15 insertions(+), 3 deletions(-)
 create mode 100644 qCC/config.h.in

--- a/qCC/ccGLWindow.cpp
+++ b/qCC/ccGLWindow.cpp
@@ -23,6 +23,9 @@
 #include "ccGuiParameters.h"
 #include "ccRenderingTools.h"
 
+//config : handle dynamic directory creation
+#include "config.h"
+
 //qCC_db
 #include <ccLog.h>
 #include <ccHObject.h>
@@ -318,7 +321,7 @@ void ccGLWindow::initializeGL()
 			else
 			{
 				ccColorRampShader* colorRampShader = new ccColorRampShader();
-				QString shadersPath = ccGLWindow::getShadersPath();
+				QString shadersPath = ShaderInstallDir;
 				if (!colorRampShader->loadProgram(0,qPrintable(shadersPath+QString("/ColorRamp/color_ramp.frag"))))
 				{
 					ccLog::Warning("[3D View %i] Failed to load color ramp shader!",m_uniqueID);
@@ -3134,7 +3137,7 @@ bool ccGLWindow::renderToFile(	const cha
 
 			if (m_activeGLFilter && !filter)
 			{
-				QString shadersPath = ccGLWindow::getShadersPath();
+				QString shadersPath = ShaderInstallDir;
 
 				if (!m_activeGLFilter->init(Wp,Hp,qPrintable(shadersPath)))
 				{
@@ -3397,7 +3400,7 @@ bool ccGLWindow::initGLFilter(int w, int
 	ccGlFilter* _filter = m_activeGLFilter;
 	m_activeGLFilter=0;
 
-	QString shadersPath = ccGLWindow::getShadersPath();
+	QString shadersPath = ShaderInstallDir;
 
 	//ccLog::Print(QString("Shaders path: %1").arg(shadersPath));
 
--- a/qCC/config.h.in
+++ b/qCC/config.h.in
@@ -0,0 +1,2 @@
+#define ShaderInstallDir "@CloudCompare_shaders_dest_release@"
+#define PluginInstallDir "@CloudCompare_plugins_dest_release@"
--- a/qCC/mainwindow.cpp
+++ b/qCC/mainwindow.cpp
@@ -17,6 +17,9 @@
 
 #include "mainwindow.h"
 #include <iostream>
+//Dynamic directories
+#include "config.h"
+
 //CCLib Includes
 #include <GenericChunkedArray.h>
 #include <CloudSamplingTools.h>
@@ -337,7 +340,7 @@ void MainWindow::loadPlugins()
     m_pluginsPath = path + "Plugins/ccPlugins";
 #else
     //plugins are in bin/plugins
-    m_pluginsPath = QCoreApplication::applicationDirPath()+QString("/plugins");
+    m_pluginsPath = PluginInstallDir;
 #endif
 
     ccConsole::Print(QString("Plugins lookup dir.: %1").arg(m_pluginsPath));
--- a/qCC/CMakeLists.txt
+++ b/qCC/CMakeLists.txt
@@ -7,13 +7,23 @@ set( VERSION_MINOR 5 )
 set( VERSION_PATCH 0 )
 
 if ( UNIX )
-	set( CloudCompare_dest_release bin ) #default destination: /usr/bin
+	set( CloudCompare_dest_release /usr/bin ) #default destination: /usr/bin
 	set( CloudCompare_dest_debug bin/debug )
+	set( CloudCompare_shaders_dest_release /usr/share/cloudcompare/shaders )
+    set( CloudCompare_plugins_dest_release /usr/lib/cloudcompare/plugins )
 else()
 	set( CloudCompare_dest_release CloudCompare )
 	set( CloudCompare_dest_debug CloudCompare_debug )
+    set( CloudCompare_shaders_dest_release CloudCompare/shaders )
+    set( CloudCompare_plugins_dest_release CloudCompare/plugins )
 endif()
 
+# config / shader path
+configure_file (
+  "config.h.in"
+  "${CMAKE_CURRENT_SOURCE_DIR}/config.h"
+  )
+
 if( APPLE )
    set( MAC_APP_NAME ${PROJECT_NAME}.app )
    set( MAC_BUNDLE_MACOS_DIR ${CMAKE_INSTALL_PREFIX}/${CloudCompare_dest_release}/${MAC_APP_NAME}/Contents/MacOS )
@@ -142,9 +152,9 @@ if( APPLE )
    install( FILES ${CC_FBO_SOURCE_DIR}/bilateral/bilateral.vert DESTINATION ${MAC_BUNDLE_SHADERS_DIR} )
    install( FILES ${CMAKE_CURRENT_SOURCE_DIR}/shaders/ColorRamp/color_ramp.frag DESTINATION ${MAC_BUNDLE_SHADERS_DIR}/ColorRamp )
 else()
-   install_ext( FILES ${CC_FBO_SOURCE_DIR}/bilateral/bilateral.frag ${CloudCompare_dest_release}/shaders ${CloudCompare_dest_debug}/shaders )
-   install_ext( FILES ${CC_FBO_SOURCE_DIR}/bilateral/bilateral.vert ${CloudCompare_dest_release}/shaders ${CloudCompare_dest_debug}/shaders )
-   install_ext( FILES ${CMAKE_CURRENT_SOURCE_DIR}/shaders/ColorRamp/color_ramp.frag ${CloudCompare_dest_release}/shaders/ColorRamp ${CloudCompare_dest_debug}/shaders/ColorRamp )
+   install_ext( FILES ${CC_FBO_SOURCE_DIR}/bilateral/bilateral.frag ${CloudCompare_shaders_dest_release} ${CloudCompare_dest_debug}/shaders )
+   install_ext( FILES ${CC_FBO_SOURCE_DIR}/bilateral/bilateral.vert ${CloudCompare_shaders_dest_release} ${CloudCompare_dest_debug}/shaders )
+   install_ext( FILES ${CMAKE_CURRENT_SOURCE_DIR}/shaders/ColorRamp/color_ramp.frag ${CloudCompare_shaders_dest_release}/ColorRamp ${CloudCompare_dest_debug}/shaders/ColorRamp )
 endif()
 
 # Auxiliary files
--- a/qCC/plugins/CMakePluginTpl.cmake
+++ b/qCC/plugins/CMakePluginTpl.cmake
@@ -74,7 +74,7 @@ if( APPLE )
    install( TARGETS ${PROJECT_NAME} LIBRARY DESTINATION ${MAC_BUNDLE_PLUGIN_DIR}/ccPlugins COMPONENT Runtime )
    set( CC_PLUGINS ${CC_PLUGINS} ${MAC_BUNDLE_PLUGIN_DIR}/ccPlugins/lib${PROJECT_NAME}${CMAKE_SHARED_LIBRARY_SUFFIX} CACHE INTERNAL "cc plugin list" )
 else()
-   install_shared( ${PROJECT_NAME} ${CloudCompare_dest_release}/plugins ${CloudCompare_dest_debug}/plugins )
+    install_shared( ${PROJECT_NAME} ${CloudCompare_plugins_dest_release} ${CloudCompare_dest_debug}/plugins )
 endif()
 
 if( CC_SHADER_FOLDER )
@@ -83,7 +83,7 @@ if( CC_SHADER_FOLDER )
       if( APPLE )
          install( FILES ${filename} DESTINATION ${MAC_BUNDLE_SHADERS_DIR}/${CC_SHADER_FOLDER} )
       else()
-         install_ext( FILES ${filename} ${CloudCompare_dest_release}/shaders/${CC_SHADER_FOLDER} ${CloudCompare_dest_debug}/shaders/${CC_SHADER_FOLDER} )
+          install_ext( FILES ${filename} ${CloudCompare_shaders_dest_release}/${CC_SHADER_FOLDER} ${qCC_dest_debug}/shaders/${CC_SHADER_FOLDER} )
       endif()
 	endforeach()
 endif()
--- a/ccViewer/CMakeLists.txt
+++ b/ccViewer/CMakeLists.txt
@@ -152,8 +152,8 @@ if( APPLE )
 endif( APPLE )
 
 # Export common shader files to all install destinations
-if( APPLE )
-   install( FILES ${CMAKE_CURRENT_SOURCE_DIR}/../qCC/shaders/ColorRamp/color_ramp.frag DESTINATION ${MAC_BUNDLE_SHADERS_DIR}/ColorRamp )
-else()
-   install_ext( FILES ${CMAKE_CURRENT_SOURCE_DIR}/../qCC/shaders/ColorRamp/color_ramp.frag ${ccViewer_dest_release}/shaders/ColorRamp ${ccViewer_dest_debug}/shaders/ColorRamp )
-endif()
+# if( APPLE )
+#   install( FILES ${CMAKE_CURRENT_SOURCE_DIR}/../qCC/shaders/ColorRamp/color_ramp.frag DESTINATION ${MAC_BUNDLE_SHADERS_DIR}/ColorRamp )
+# else()
+#   install_ext( FILES ${CMAKE_CURRENT_SOURCE_DIR}/../qCC/shaders/ColorRamp/color_ramp.frag ${ccViewer_dest_release}/shaders/ColorRamp ${ccViewer_dest_debug}/shaders/ColorRamp )
+# endif()
